<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CounterAPI Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
	</head>
	<body class="bg-light">
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">ðŸ“Š CounterAPI</a>
			</div>
		</nav>

		<div class="container py-4">
			<h1 class="mb-4">Project Counter Dashboard</h1>

			<div class="mb-3 d-flex">
				<input
					type="text"
					id="project-name"
					class="form-control me-2"
					placeholder="Enter project name"
				/>
				<input
					type="text"
					id="project-desc"
					class="form-control me-2"
					placeholder="Optional description"
				/>
				<button class="btn btn-primary" onclick="addProject()">
					Add Project
				</button>
			</div>

			<div id="project-list" class="row g-4"></div>
		</div>

		<script>
			const apiBase = getOrPromptBaseURL();

			function getOrPromptBaseURL() {
				let url = localStorage.getItem("apiBase");
				if (!url) {
					url = prompt(
						"Enter your Render backend URL (e.g., https://your-app.onrender.com)"
					)?.trim();
					if (!url) alert("A valid URL is required.");
					else localStorage.setItem("apiBase", url);
				}
				return url;
			}

			function loadProjects() {
				fetch(`${apiBase}/projects`)
					.then((res) => res.json())
					.then((data) => {
						const container =
							document.getElementById("project-list");
						container.innerHTML = "";
						data.forEach((p) => renderCard(p));
					});
			}

			function renderCard(project) {
				const container = document.getElementById("project-list");
				const col = document.createElement("div");
				col.className = "col-md-4";

				col.innerHTML = `
        <div class="card shadow">
          <div class="card-body">
            <h5 class="card-title">${project.name}</h5>
            ${project.description ? `<p>${project.description}</p>` : ""}
            <p><strong>Count:</strong> ${project.count}</p>
            <button class="btn btn-success me-2" onclick="pingProject('${
				project.name
			}')">Ping</button>
            <button class="btn btn-warning me-2" onclick="editProject('${
				project.name
			}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteProject('${
				project.name
			}')">Delete</button>
          </div>
        </div>
      `;
				container.appendChild(col);
			}

			function addProject() {
				const name = document
					.getElementById("project-name")
					.value.trim();
				const description = document
					.getElementById("project-desc")
					.value.trim();
				if (!name) return alert("Please enter a project name.");
				fetch(`${apiBase}/projects`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ name, description }),
				}).then((res) => {
					if (!res.ok) return res.text().then((txt) => alert(txt));
					document.getElementById("project-name").value = "";
					document.getElementById("project-desc").value = "";
					loadProjects();
				});
			}

			function pingProject(name) {
				fetch(`${apiBase}/ping`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ name }),
				}).then(loadProjects);
			}

			function editProject(oldName) {
				const newName = prompt("New name:", oldName);
				const newDesc = prompt("New description:");
				const newCount = prompt(
					"New count (leave blank to keep unchanged):"
				);

				const body = {
					new_name: newName || oldName,
					description: newDesc,
					count: newCount ? parseInt(newCount) : undefined,
				};

				fetch(
					`${apiBase}/projects?name=${encodeURIComponent(oldName)}`,
					{
						method: "PUT",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(body),
					}
				).then(loadProjects);
			}

			function deleteProject(name) {
				if (!confirm(`Are you sure you want to delete "${name}"?`))
					return;
				fetch(`${apiBase}/projects?name=${encodeURIComponent(name)}`, {
					method: "DELETE",
				}).then(loadProjects);
			}

			loadProjects();
		</script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
